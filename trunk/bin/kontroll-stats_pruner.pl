#! /usr/bin/perl
################################################################################
## NAME: kontroll-stats_pruner.pl
## VERSION: 2.0.1
## DATE: 2010-08-03
## AUTHOR: Matt Reid
## WEBSITE: http://kontrollsoft.com
## EMAIL: kontact@kontrollsoft.com
## LICENSE: PLEASE REFER TO THE LICENSE.txt file bundled with this software release
## to understand your right and options for using this software.
## Copyright 2008 Kontrollsoft LLC
## All rights reserved.
################################################################################

use strict;
use warnings;
use DBI;
use Fcntl;
use POSIX qw(strftime);
use Time::HiRes qw(gettimeofday tv_interval);

my $mysql_r_user = undef;
my $mysql_r_pass = undef;
my $mysql_r_db = undef;
my $mysql_r_host = undef;
my $error_log = undef;
my $debug_log = undef;
my $datetime =  strftime "%Y-%m-%d %H:%M:%S", localtime;

#interval days value to prune
my $interval = "180"; #default 180 days / 6 months

# If you have issues with the php binary not being found please specify the full path in the commands below.
sub config_connect {    
    my $cfgapp = "../system/application/config/bin-read-configs.php";
    $mysql_r_user = `php $cfgapp read username`;
    $mysql_r_pass = `php $cfgapp read password`;
    $mysql_r_db = `php $cfgapp read database`;
    $mysql_r_host = `php $cfgapp read hostname`;
    $error_log = "../system/logs/sys_error.log";
    $debug_log = "../system/logs/sys_debug.log";
}

sub debug_clear {
    my $note = "LOG TRUNCATED";
    my $debugtime =  strftime "%Y-%m-%d %H:%M:%S", localtime;
    $note = $debugtime." | DEBUG | server-loop-5.0.x_linux-x86: ".$note."\n";
    print $note;
    sysopen(FILE, $debug_log, O_RDWR|O_EXCL|O_CREAT, 0644);
    open FILE, ">$debug_log" or die $!;
    print FILE $note;
    close FILE;
}

sub debug_report {
    my $note = $_[0];
    my $debugtime =  strftime "%Y-%m-%d %H:%M:%S", localtime;
    $note = $debugtime." | DEBUG | server-loop-5.0.x_linux-x86: ".$note."\n";
    print $note;
    sysopen(FILE, $debug_log, O_RDWR|O_EXCL|O_CREAT, 0644);
    open FILE, ">>$debug_log" or die $!;
    print FILE $note;
    close FILE;
}

sub error_report {
    my $err = $_[0];
    my $errtime =  strftime "%Y-%m-%d %H:%M:%S", localtime;
    $err = $errtime." | server-loop-5.0.x_linux-x86: ".$err."\n";
    print $err."\n";
    sysopen(FILE, $error_log, O_RDWR|O_EXCL|O_CREAT, 0644);    
    open FILE, ">>$error_log" or die $!; 
    print FILE $err; 
    close FILE;   
    exit 1;
}

sub stats_pruner {
    my $dbh = DBI->connect( 
        "DBI:mysql:$mysql_r_db:$mysql_r_host", 
        $mysql_r_user, 
        $mysql_r_pass,
        {
            PrintError => 0,
            RaiseError => 0,
	    AutoCommit => 0
        }
    ) or error_report("$DBI::errstr");
    
    #select records from main table into archive table
    my $sql0 = "INSERT INTO server_statistics_archive (
`id`,
`server_list_id`,
`cnf_file`,
`os_load_1`,
`os_load_5`,
`os_load_15`,
`os_mem_total`,
`os_mem_used`,
`os_swap_total`,
`os_swap_free`,
`os_cpu_user`,
`os_cpu_system`,
`os_cpu_idle`,
`queries_per_second`,
`num_schema`,
`num_tables`,
`num_connections`,
`length_data`,
`length_index`,
`engine_count_innodb`,
`engine_count_myisam`,
`engine_myisam_size_data`,
`engine_myisam_size_index`,
`engine_innodb_size_data`,
`engine_innodb_size_index`,
`auto_increment_increment`,
`auto_increment_offset`,
`automatic_sp_privileges`,
`back_log`,
`basedir`,
`binlog_cache_size`,
`bulk_insert_buffer_size`,
`character_set_client`,
`character_set_connection`,
`character_set_database`,
`character_set_filesystem`,
`character_set_results`,
`character_set_server`,
`character_set_system`,
`character_sets_dir`,
`collation_connection`,
`collation_database`,
`collation_server`,
`completion_type`,
`concurrent_insert`,
`connect_timeout`,
`datadir`,
`date_format`,
`datetime_format`,
`default_week_format`,
`delay_key_write`,
`delayed_insert_limit`,
`delayed_insert_timeout`,
`delayed_queue_size`,
`div_precision_increment`,
`keep_files_on_create`,
`engine_condition_pushdown`,
`expire_logs_days`,
`flush`,
`flush_time`,
`ft_boolean_syntax`,
`ft_max_word_len`,
`ft_min_word_len`,
`ft_query_expansion_limit`,
`ft_stopword_file`,
`group_concat_max_len`,
`have_archive`,
`have_bdb`,
`have_blackhole_engine`,
`have_compress`,
`have_crypt`,
`have_csv`,
`have_dynamic_loading`,
`have_example_engine`,
`have_federated_engine`,
`have_geometry`,
`have_innodb`,
`have_isam`,
`have_merge_engine`,
`have_ndbcluster`,
`have_openssl`,
`have_ssl`,
`have_query_cache`,
`have_raid`,
`have_rtree_keys`,
`have_symlink`,
`hostname`,
`init_connect`,
`init_file`,
`init_slave`,
`innodb_additional_mem_pool_size`,
`innodb_autoextend_increment`,
`innodb_buffer_pool_awe_mem_mb`,
`innodb_buffer_pool_size`,
`innodb_checksums`,
`innodb_commit_concurrency`,
`innodb_concurrency_tickets`,
`innodb_data_file_path`,
`innodb_data_home_dir`,
`innodb_adaptive_hash_index`,
`innodb_doublewrite`,
`innodb_fast_shutdown`,
`innodb_file_io_threads`,
`innodb_file_per_table`,
`innodb_flush_log_at_trx_commit`,
`innodb_flush_method`,
`innodb_force_recovery`,
`innodb_lock_wait_timeout`,
`innodb_locks_unsafe_for_binlog`,
`innodb_log_arch_dir`,
`innodb_log_archive`,
`innodb_log_buffer_size`,
`innodb_log_file_size`,
`innodb_log_files_in_group`,
`innodb_log_group_home_dir`,
`innodb_max_dirty_pages_pct`,
`innodb_max_purge_lag`,
`innodb_mirrored_log_groups`,
`innodb_open_files`,
`innodb_rollback_on_timeout`,
`innodb_support_xa`,
`innodb_sync_spin_loops`,
`innodb_table_locks`,
`innodb_thread_concurrency`,
`innodb_thread_sleep_delay`,
`innodb_read_ahead`,
`innodb_ibuf_contract_const`,
`innodb_ibuf_contract_burst`,
`innodb_buf_flush_const`,
`innodb_buf_flush_burst`,
`interactive_timeout`,
`join_buffer_size`,
`key_buffer_size`,
`key_cache_age_threshold`,
`key_cache_block_size`,
`key_cache_division_limit`,
`language`,
`large_files_support`,
`large_page_size`,
`large_pages`,
`lc_time_names`,
`license`,
`local_infile`,
`locked_in_memory`,
`log`,
`log_bin`,
`log_bin_trust_function_creators`,
`log_error`,
`log_queries_not_using_indexes`,
`log_slave_updates`,
`log_slow_queries`,
`log_slow_filter`,
`log_slow_verbosity`,
`log_warnings`,
`long_query_time`,
`low_priority_updates`,
`lower_case_file_system`,
`lower_case_table_names`,
`max_allowed_packet`,
`max_binlog_cache_size`,
`max_binlog_size`,
`max_connect_errors`,
`max_connections`,
`max_delayed_threads`,
`max_error_count`,
`max_heap_table_size`,
`max_insert_delayed_threads`,
`max_join_size`,
`max_length_for_sort_data`,
`max_prepared_stmt_count`,
`max_relay_log_size`,
`max_seeks_for_key`,
`max_sort_length`,
`max_sp_recursion_depth`,
`max_tmp_tables`,
`max_user_connections`,
`max_write_lock_count`,
`min_examined_row_limit`,
`multi_range_count`,
`myisam_data_pointer_size`,
`myisam_max_sort_file_size`,
`myisam_recover_options`,
`myisam_repair_threads`,
`myisam_sort_buffer_size`,
`myisam_stats_method`,
`net_buffer_length`,
`net_read_timeout`,
`net_retry_count`,
`net_write_timeout`,
`new`,
`old_passwords`,
`open_files_limit`,
`optimizer_prune_level`,
`optimizer_search_depth`,
`pid_file`,
`port`,
`preload_buffer_size`,
`protocol_version`,
`query_alloc_block_size`,
`query_cache_limit`,
`query_cache_min_res_unit`,
`query_cache_size`,
`query_cache_type`,
`query_cache_wlock_invalidate`,
`query_prealloc_size`,
`range_alloc_block_size`,
`log_slow_rate_limit`,
`read_buffer_size`,
`read_only`,
`read_rnd_buffer_size`,
`relay_log`,
`relay_log_index`,
`relay_log_info_file`,
`relay_log_purge`,
`relay_log_space_limit`,
`rpl_recovery_rank`,
`secure_auth`,
`secure_file_priv`,
`server_id`,
`skip_external_locking`,
`skip_networking`,
`skip_show_database`,
`slave_compressed_protocol`,
`slave_load_tmpdir`,
`slave_net_timeout`,
`slave_skip_errors`,
`slave_transaction_retries`,
`slow_launch_time`,
`socket`,
`sort_buffer_size`,
`sql_big_selects`,
`sql_mode`,
`sql_notes`,
`sql_warnings`,
`ssl_ca`,
`ssl_capath`,
`ssl_cert`,
`ssl_cipher`,
`ssl_key`,
`storage_engine`,
`sync_binlog`,
`sync_frm`,
`system_time_zone`,
`table_cache`,
`table_lock_wait_timeout`,
`table_type`,
`thread_cache_size`,
`thread_stack`,
`time_format`,
`time_zone`,
`timed_mutexes`,
`tmp_table_size`,
`tmpdir`,
`transaction_alloc_block_size`,
`transaction_prealloc_size`,
`tx_isolation`,
`updatable_views_with_limit`,
`version`,
`version_comment`,
`version_compile_machine`,
`version_compile_os`,
`wait_timeout`,
`Aborted_clients`,
`Aborted_connects`,
`Binlog_cache_disk_use`,
`Binlog_cache_use`,
`Bytes_received`,
`Bytes_sent`,
`Com_admin_commands`,
`Com_alter_db`,
`Com_alter_table`,
`Com_analyze`,
`Com_backup_table`,
`Com_begin`,
`Com_call_procedure`,
`Com_change_db`,
`Com_change_master`,
`Com_check`,
`Com_checksum`,
`Com_commit`,
`Com_create_db`,
`Com_create_function`,
`Com_create_index`,
`Com_create_table`,
`Com_create_user`,
`Com_dealloc_sql`,
`Com_delete`,
`Com_delete_multi`,
`Com_do`,
`Com_drop_db`,
`Com_drop_function`,
`Com_drop_index`,
`Com_drop_table`,
`Com_drop_user`,
`Com_execute_sql`,
`Com_flush`,
`Com_grant`,
`Com_ha_close`,
`Com_ha_open`,
`Com_ha_read`,
`Com_help`,
`Com_insert`,
`Com_insert_select`,
`Com_kill`,
`Com_load`,
`Com_load_master_data`,
`Com_load_master_table`,
`Com_lock_tables`,
`Com_optimize`,
`Com_preload_keys`,
`Com_prepare_sql`,
`Com_purge`,
`Com_purge_before_date`,
`Com_rename_table`,
`Com_repair`,
`Com_replace`,
`Com_replace_select`,
`Com_reset`,
`Com_restore_table`,
`Com_revoke`,
`Com_revoke_all`,
`Com_rollback`,
`Com_savepoint`,
`Com_select`,
`Com_set_option`,
`Com_show_binlog_events`,
`Com_show_binlogs`,
`Com_show_charsets`,
`Com_show_collations`,
`Com_show_column_types`,
`Com_show_create_db`,
`Com_show_create_table`,
`Com_show_databases`,
`Com_show_errors`,
`Com_show_fields`,
`Com_show_grants`,
`Com_show_innodb_status`,
`Com_show_keys`,
`Com_show_logs`,
`Com_show_master_status`,
`Com_show_ndb_status`,
`Com_show_new_master`,
`Com_show_open_tables`,
`Com_show_privileges`,
`Com_show_processlist`,
`Com_show_slave_hosts`,
`Com_show_slave_status`,
`Com_show_status`,
`Com_show_storage_engines`,
`Com_show_tables`,
`Com_show_triggers`,
`Com_show_variables`,
`Com_show_warnings`,
`Com_slave_start`,
`Com_slave_stop`,
`Com_stmt_close`,
`Com_stmt_execute`,
`Com_stmt_fetch`,
`Com_stmt_prepare`,
`Com_stmt_reset`,
`Com_stmt_send_long_data`,
`Com_truncate`,
`Com_unlock_tables`,
`Com_update`,
`Com_update_multi`,
`Com_xa_commit`,
`Com_xa_end`,
`Com_xa_prepare`,
`Com_xa_recover`,
`Com_xa_rollback`,
`Com_xa_start`,
`Compression`,
`Connections`,
`Created_tmp_disk_tables`,
`Created_tmp_files`,
`Created_tmp_tables`,
`Delayed_errors`,
`Delayed_insert_threads`,
`Delayed_writes`,
`Flush_commands`,
`Handler_commit`,
`Handler_delete`,
`Handler_discover`,
`Handler_prepare`,
`Handler_read_first`,
`Handler_read_key`,
`Handler_read_next`,
`Handler_read_prev`,
`Handler_read_rnd`,
`Handler_read_rnd_next`,
`Handler_rollback`,
`Handler_savepoint`,
`Handler_savepoint_rollback`,
`Handler_update`,
`Handler_write`,
`Innodb_buffer_pool_pages_data`,
`Innodb_buffer_pool_pages_dirty`,
`Innodb_buffer_pool_pages_flushed`,
`Innodb_buffer_pool_pages_free`,
`Innodb_buffer_pool_pages_misc`,
`Innodb_buffer_pool_pages_total`,
`Innodb_buffer_pool_read_ahead_rnd`,
`Innodb_buffer_pool_read_ahead_seq`,
`Innodb_buffer_pool_read_requests`,
`Innodb_buffer_pool_reads`,
`Innodb_buffer_pool_wait_free`,
`Innodb_buffer_pool_write_requests`,
`Innodb_data_fsyncs`,
`Innodb_data_pending_fsyncs`,
`Innodb_data_pending_reads`,
`Innodb_data_pending_writes`,
`Innodb_data_read`,
`Innodb_data_reads`,
`Innodb_data_writes`,
`Innodb_data_written`,
`Innodb_dblwr_pages_written`,
`Innodb_dblwr_writes`,
`Innodb_log_waits`,
`Innodb_log_write_requests`,
`Innodb_log_writes`,
`Innodb_os_log_fsyncs`,
`Innodb_os_log_pending_fsyncs`,
`Innodb_os_log_pending_writes`,
`Innodb_os_log_written`,
`Innodb_page_size`,
`Innodb_pages_created`,
`Innodb_pages_read`,
`Innodb_pages_written`,
`Innodb_row_lock_current_waits`,
`Innodb_row_lock_time`,
`Innodb_row_lock_time_avg`,
`Innodb_row_lock_time_max`,
`Innodb_row_lock_waits`,
`Innodb_rows_deleted`,
`Innodb_rows_inserted`,
`Innodb_rows_read`,
`Innodb_rows_updated`,
`Key_blocks_not_flushed`,
`Key_blocks_unused`,
`Key_blocks_used`,
`Key_read_requests`,
`Key_reads`,
`Key_write_requests`,
`Key_writes`,
`Last_query_cost`,
`Max_used_connections`,
`Not_flushed_delayed_rows`,
`Open_files`,
`Open_streams`,
`Open_tables`,
`Opened_tables`,
`Prepared_stmt_count`,
`Qcache_free_blocks`,
`Qcache_free_memory`,
`Qcache_hits`,
`Qcache_inserts`,
`Qcache_lowmem_prunes`,
`Qcache_not_cached`,
`Qcache_queries_in_cache`,
`Qcache_total_blocks`,
`Questions`,
`Rpl_status`,
`Select_full_join`,
`Select_full_range_join`,
`Select_range`,
`Select_range_check`,
`Select_scan`,
`Slave_open_temp_tables`,
`Slave_retried_transactions`,
`Slave_running`,
`Slow_launch_threads`,
`Slow_queries`,
`Sort_merge_passes`,
`Sort_range`,
`Sort_rows`,
`Sort_scan`,
`Table_locks_immediate`,
`Table_locks_waited`,
`Tc_log_max_pages_used`,
`Tc_log_page_size`,
`Tc_log_page_waits`,
`Threads_cached`,
`Threads_connected`,
`Threads_created`,
`Threads_running`,
`Uptime`,
`server_snmp_error_code`,
`server_mysql_error_code`,
`Slave_IO_Running`,
`Slave_SQL_Running`,
`Seconds_Behind_Master`,
`illegal_global_user`,
`illegal_grant_user`,
`illegal_remote_root`,
`illegal_user_nopass`,
`illegal_user_noname`,
`collection_time_elapse`,
`Creation_time`) 
SELECT * FROM server_statistics  WHERE Creation_time < DATE_SUB(CURDATE(), INTERVAL $interval DAY);";
    #delete records from main table 
    my $sql1 = "DELETE FROM server_statistics WHERE Creation_time < DATE_SUB(CURDATE(), INTERVAL $interval DAY);";

    debug_report("#### stats_pruner queries prepared.");
    #begin transactions
    eval {	
	debug_report("#### stats_pruner queries executing.");
	$dbh->do($sql0);
	$dbh->do($sql1);
	$dbh->commit();	
    };

    if ($@) {
	print "Transaction aborted: $@";
	$dbh->rollback();
    }

    debug_report("#### stats_pruner statements committed.");
    $dbh->disconnect();
    debug_report("#### stats_pruner database handler disconnected.");
}

config_connect();
debug_report("#### stats_pruner start");
stats_pruner();
debug_report("#### stats_pruner end");
